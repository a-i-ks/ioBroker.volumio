{
  "version": 3,
  "sources": ["../../src/lib/restVolumioClient.ts"],
  "sourcesContent": ["/**\n * REST API implementation of Volumio Client\n *\n * This client communicates with Volumio using the REST API.\n * Polling is used to detect state changes.\n */\n\nimport type { AxiosInstance } from \"axios\";\nimport axios from \"axios\";\nimport type {\n  IVolumioClient,\n  VolumioState,\n  VolumioSystemInfo,\n  StateChangeCallback,\n  ConnectionStateCallback,\n} from \"./volumioClient\";\n\nexport interface RestClientConfig {\n  host: string;\n  port: number;\n  pollInterval?: number; // Polling interval in ms (default: 2000)\n}\n\nexport class RestVolumioClient implements IVolumioClient {\n  private config: RestClientConfig;\n  private axiosInstance: AxiosInstance;\n  private connected: boolean = false;\n  private pollTimer?: NodeJS.Timeout;\n  private lastState?: VolumioState;\n  private stateChangeCallbacks: StateChangeCallback[] = [];\n  private connectionChangeCallbacks: ConnectionStateCallback[] = [];\n\n  constructor(config: RestClientConfig) {\n    this.config = {\n      ...config,\n      pollInterval: config.pollInterval || 2000,\n    };\n\n    this.axiosInstance = axios.create({\n      baseURL: `http://${config.host}:${config.port}`,\n      timeout: 5000,\n    });\n  }\n\n  async connect(): Promise<void> {\n    try {\n      // Test connection by getting state\n      await this.getState();\n      this.connected = true;\n      this.notifyConnectionChange(true);\n\n      // Start polling for state changes\n      this.startPolling();\n    } catch (error) {\n      this.connected = false;\n      this.notifyConnectionChange(false);\n      throw new Error(`Failed to connect to Volumio: ${error}`);\n    }\n  }\n\n  async disconnect(): Promise<void> {\n    this.stopPolling();\n    this.connected = false;\n    this.notifyConnectionChange(false);\n  }\n\n  isConnected(): boolean {\n    return this.connected;\n  }\n\n  async ping(): Promise<boolean> {\n    try {\n      await this.axiosInstance.get(\"/api/v1/getState\");\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  onStateChange(callback: StateChangeCallback): void {\n    this.stateChangeCallbacks.push(callback);\n  }\n\n  onConnectionChange(callback: ConnectionStateCallback): void {\n    this.connectionChangeCallbacks.push(callback);\n  }\n\n  async getState(): Promise<VolumioState> {\n    const response =\n      await this.axiosInstance.get<VolumioState>(\"/api/v1/getState\");\n    return response.data;\n  }\n\n  async getSystemInfo(): Promise<VolumioSystemInfo> {\n    const response = await this.axiosInstance.get<VolumioSystemInfo>(\n      \"/api/v1/getSystemInfo\",\n    );\n    return response.data;\n  }\n\n  // ==================== Playback Control ====================\n\n  async play(n?: number): Promise<void> {\n    const cmd = n !== undefined ? `play&N=${n}` : \"play\";\n    await this.sendCommand(cmd);\n  }\n\n  async pause(): Promise<void> {\n    await this.sendCommand(\"pause\");\n  }\n\n  async stop(): Promise<void> {\n    await this.sendCommand(\"stop\");\n  }\n\n  async toggle(): Promise<void> {\n    await this.sendCommand(\"toggle\");\n  }\n\n  async next(): Promise<void> {\n    await this.sendCommand(\"next\");\n  }\n\n  async previous(): Promise<void> {\n    await this.sendCommand(\"prev\");\n  }\n\n  async seek(position: number): Promise<void> {\n    await this.sendCommand(`seek&position=${position}`);\n  }\n\n  // ==================== Volume Control ====================\n\n  async setVolume(volume: number): Promise<void> {\n    if (volume < 0 || volume > 100) {\n      throw new Error(\"Volume must be between 0 and 100\");\n    }\n    await this.sendCommand(`volume&volume=${volume}`);\n  }\n\n  async volumePlus(): Promise<void> {\n    await this.sendCommand(\"volume&volume=plus\");\n  }\n\n  async volumeMinus(): Promise<void> {\n    await this.sendCommand(\"volume&volume=minus\");\n  }\n\n  async mute(): Promise<void> {\n    await this.sendCommand(\"volume&volume=mute\");\n  }\n\n  async unmute(): Promise<void> {\n    await this.sendCommand(\"volume&volume=unmute\");\n  }\n\n  async toggleMute(): Promise<void> {\n    await this.sendCommand(\"volume&volume=toggle\");\n  }\n\n  // ==================== Queue Management ====================\n\n  async clearQueue(): Promise<void> {\n    await this.sendCommand(\"clearQueue\");\n  }\n\n  // ==================== Playback Options ====================\n\n  async setRandom(enabled: boolean): Promise<void> {\n    await this.sendCommand(`random&value=${enabled ? \"true\" : \"false\"}`);\n  }\n\n  async setRepeat(enabled: boolean): Promise<void> {\n    await this.sendCommand(`repeat&value=${enabled ? \"true\" : \"false\"}`);\n  }\n\n  async setRepeatSingle(enabled: boolean): Promise<void> {\n    await this.sendCommand(`repeatSingle&value=${enabled ? \"true\" : \"false\"}`);\n  }\n\n  // ==================== Private Methods ====================\n\n  private async sendCommand(cmd: string): Promise<void> {\n    await this.axiosInstance.get(`/api/v1/commands/?cmd=${cmd}`);\n  }\n\n  private startPolling(): void {\n    if (this.pollTimer) {\n      return;\n    }\n\n    this.pollTimer = setInterval(async () => {\n      try {\n        const state = await this.getState();\n        this.checkStateChange(state);\n      } catch (_error) {\n        // Connection lost\n        if (this.connected) {\n          this.connected = false;\n          this.notifyConnectionChange(false);\n        }\n      }\n    }, this.config.pollInterval);\n  }\n\n  private stopPolling(): void {\n    if (this.pollTimer) {\n      clearInterval(this.pollTimer);\n      this.pollTimer = undefined;\n    }\n  }\n\n  private checkStateChange(newState: VolumioState): void {\n    // Compare relevant state fields to detect changes\n    if (!this.lastState || this.hasStateChanged(this.lastState, newState)) {\n      this.lastState = newState;\n      this.notifyStateChange(newState);\n    }\n  }\n\n  private hasStateChanged(\n    oldState: VolumioState,\n    newState: VolumioState,\n  ): boolean {\n    // Check key fields that indicate a meaningful state change\n    return (\n      oldState.status !== newState.status ||\n      oldState.position !== newState.position ||\n      oldState.title !== newState.title ||\n      oldState.volume !== newState.volume ||\n      oldState.mute !== newState.mute ||\n      oldState.random !== newState.random ||\n      oldState.repeat !== newState.repeat\n    );\n  }\n\n  private notifyStateChange(state: VolumioState): void {\n    for (const callback of this.stateChangeCallbacks) {\n      try {\n        callback(state);\n      } catch (_error) {\n        // Ignore callback errors\n      }\n    }\n  }\n\n  private notifyConnectionChange(connected: boolean): void {\n    for (const callback of this.connectionChangeCallbacks) {\n      try {\n        callback(connected);\n      } catch (_error) {\n        // Ignore callback errors\n      }\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": ["axios"]
}
