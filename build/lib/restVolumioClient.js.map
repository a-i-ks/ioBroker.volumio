{
  "version": 3,
  "sources": ["../../src/lib/restVolumioClient.ts"],
  "sourcesContent": ["/**\n * REST API implementation of Volumio Client\n *\n * This client communicates with Volumio using the REST API.\n * Polling is used to detect state changes.\n */\n\nimport type { AxiosInstance } from \"axios\";\nimport axios from \"axios\";\nimport type {\n  IVolumioClient,\n  VolumioState,\n  VolumioSystemInfo,\n  StateChangeCallback,\n  ConnectionStateCallback,\n} from \"./volumioClient\";\nimport type { Logger } from \"./logger\";\nimport { NoOpLogger } from \"./logger\";\n\nexport interface RestClientConfig {\n  host: string;\n  port: number;\n  pollInterval?: number; // Polling interval in ms (default: 2000)\n  logger?: Logger; // Logger instance (optional)\n}\n\nexport class RestVolumioClient implements IVolumioClient {\n  private config: Required<RestClientConfig>;\n  private axiosInstance: AxiosInstance;\n  private connected: boolean = false;\n  private logger: Logger;\n  private pollTimer?: NodeJS.Timeout;\n  private lastState?: VolumioState;\n  private stateChangeCallbacks: StateChangeCallback[] = [];\n  private connectionChangeCallbacks: ConnectionStateCallback[] = [];\n\n  constructor(config: RestClientConfig) {\n    this.config = {\n      ...config,\n      pollInterval: config.pollInterval ?? 2000,\n      logger: config.logger ?? new NoOpLogger(),\n    };\n\n    this.logger = this.config.logger;\n    this.logger.debug(\n      `REST client initialized: ${this.config.host}:${this.config.port} (poll: ${this.config.pollInterval}ms)`,\n    );\n\n    this.axiosInstance = axios.create({\n      baseURL: `http://${config.host}:${config.port}`,\n      timeout: 5000,\n    });\n  }\n\n  async connect(): Promise<void> {\n    this.logger.info(\n      `Connecting to Volumio via REST API: http://${this.config.host}:${this.config.port}`,\n    );\n\n    try {\n      this.logger.debug(\"Testing connection with getState() call...\");\n      // Test connection by getting state\n      const state = await this.getState();\n      this.logger.silly(`Initial state: ${JSON.stringify(state)}`);\n\n      this.connected = true;\n      this.notifyConnectionChange(true);\n      this.logger.info(\"REST API connection successful\");\n\n      // Start polling for state changes\n      this.logger.debug(\n        `Starting state polling (interval: ${this.config.pollInterval}ms)`,\n      );\n      this.startPolling();\n    } catch (error) {\n      this.connected = false;\n      this.notifyConnectionChange(false);\n\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      const errorDetails = axios.isAxiosError(error)\n        ? {\n            status: error.response?.status,\n            statusText: error.response?.statusText,\n            code: error.code,\n          }\n        : {};\n\n      this.logger.error(\n        `Failed to connect to Volumio at ${this.config.host}:${this.config.port}: ${errorMessage} ${JSON.stringify(errorDetails)}`,\n      );\n\n      throw new Error(\n        `Failed to connect to Volumio at ${this.config.host}:${this.config.port} - ${errorMessage}`,\n      );\n    }\n  }\n\n  async disconnect(): Promise<void> {\n    this.logger.info(\"Disconnecting REST client...\");\n    this.stopPolling();\n    this.connected = false;\n    this.notifyConnectionChange(false);\n    this.logger.debug(\"REST client disconnected\");\n  }\n\n  isConnected(): boolean {\n    return this.connected;\n  }\n\n  async ping(): Promise<boolean> {\n    this.logger.debug(\"Pinging Volumio...\");\n    try {\n      await this.axiosInstance.get(\"/api/v1/getState\");\n      this.logger.debug(\"Ping successful\");\n      return true;\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      this.logger.warn(`Ping failed: ${errorMessage}`);\n      return false;\n    }\n  }\n\n  onStateChange(callback: StateChangeCallback): void {\n    this.stateChangeCallbacks.push(callback);\n  }\n\n  onConnectionChange(callback: ConnectionStateCallback): void {\n    this.connectionChangeCallbacks.push(callback);\n  }\n\n  async getState(): Promise<VolumioState> {\n    this.logger.debug(\"Fetching player state...\");\n    try {\n      const response =\n        await this.axiosInstance.get<VolumioState>(\"/api/v1/getState\");\n      this.logger.silly(`State response: ${JSON.stringify(response.data)}`);\n      return response.data;\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      this.logger.error(`getState() failed: ${errorMessage}`);\n      throw error;\n    }\n  }\n\n  async getSystemInfo(): Promise<VolumioSystemInfo> {\n    this.logger.debug(\"Fetching system info...\");\n    try {\n      const response = await this.axiosInstance.get<VolumioSystemInfo>(\n        \"/api/v1/getSystemInfo\",\n      );\n      this.logger.silly(\n        `System info response: ${JSON.stringify(response.data)}`,\n      );\n      return response.data;\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      this.logger.error(`getSystemInfo() failed: ${errorMessage}`);\n      throw error;\n    }\n  }\n\n  // ==================== Playback Control ====================\n\n  async play(n?: number): Promise<void> {\n    const cmd = n !== undefined ? `play&N=${n}` : \"play\";\n    await this.sendCommand(cmd);\n  }\n\n  async pause(): Promise<void> {\n    await this.sendCommand(\"pause\");\n  }\n\n  async stop(): Promise<void> {\n    await this.sendCommand(\"stop\");\n  }\n\n  async toggle(): Promise<void> {\n    await this.sendCommand(\"toggle\");\n  }\n\n  async next(): Promise<void> {\n    await this.sendCommand(\"next\");\n  }\n\n  async previous(): Promise<void> {\n    await this.sendCommand(\"prev\");\n  }\n\n  async seek(position: number): Promise<void> {\n    await this.sendCommand(`seek&position=${position}`);\n  }\n\n  // ==================== Volume Control ====================\n\n  async setVolume(volume: number): Promise<void> {\n    if (volume < 0 || volume > 100) {\n      throw new Error(\"Volume must be between 0 and 100\");\n    }\n    await this.sendCommand(`volume&volume=${volume}`);\n  }\n\n  async volumePlus(): Promise<void> {\n    await this.sendCommand(\"volume&volume=plus\");\n  }\n\n  async volumeMinus(): Promise<void> {\n    await this.sendCommand(\"volume&volume=minus\");\n  }\n\n  async mute(): Promise<void> {\n    await this.sendCommand(\"volume&volume=mute\");\n  }\n\n  async unmute(): Promise<void> {\n    await this.sendCommand(\"volume&volume=unmute\");\n  }\n\n  async toggleMute(): Promise<void> {\n    await this.sendCommand(\"volume&volume=toggle\");\n  }\n\n  // ==================== Queue Management ====================\n\n  async clearQueue(): Promise<void> {\n    await this.sendCommand(\"clearQueue\");\n  }\n\n  // ==================== Playback Options ====================\n\n  async setRandom(enabled: boolean): Promise<void> {\n    await this.sendCommand(`random&value=${enabled ? \"true\" : \"false\"}`);\n  }\n\n  async setRepeat(enabled: boolean): Promise<void> {\n    await this.sendCommand(`repeat&value=${enabled ? \"true\" : \"false\"}`);\n  }\n\n  async setRepeatSingle(enabled: boolean): Promise<void> {\n    await this.sendCommand(`repeatSingle&value=${enabled ? \"true\" : \"false\"}`);\n  }\n\n  // ==================== Private Methods ====================\n\n  private async sendCommand(cmd: string): Promise<void> {\n    this.logger.debug(`Sending command: ${cmd}`);\n    try {\n      await this.axiosInstance.get(`/api/v1/commands/?cmd=${cmd}`);\n      this.logger.debug(`Command ${cmd} sent successfully`);\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      this.logger.error(`Command ${cmd} failed: ${errorMessage}`);\n      throw error;\n    }\n  }\n\n  private startPolling(): void {\n    if (this.pollTimer) {\n      this.logger.warn(\"Polling already active\");\n      return;\n    }\n\n    this.logger.debug(\"Starting polling timer\");\n    this.pollTimer = setInterval(async () => {\n      try {\n        this.logger.silly(\"Polling state...\");\n        const state = await this.getState();\n        this.checkStateChange(state);\n      } catch (error) {\n        const errorMessage =\n          error instanceof Error ? error.message : String(error);\n        this.logger.warn(`Polling error: ${errorMessage}`);\n\n        // Connection lost\n        if (this.connected) {\n          this.logger.error(\"Connection lost during polling\");\n          this.connected = false;\n          this.notifyConnectionChange(false);\n        }\n      }\n    }, this.config.pollInterval);\n  }\n\n  private stopPolling(): void {\n    if (this.pollTimer) {\n      this.logger.debug(\"Stopping polling timer\");\n      clearInterval(this.pollTimer);\n      this.pollTimer = undefined;\n    }\n  }\n\n  private checkStateChange(newState: VolumioState): void {\n    // Compare relevant state fields to detect changes\n    if (!this.lastState || this.hasStateChanged(this.lastState, newState)) {\n      this.logger.debug(\"State change detected\");\n      this.logger.silly(\n        `Old state: ${JSON.stringify(this.lastState)}, New state: ${JSON.stringify(newState)}`,\n      );\n      this.lastState = newState;\n      this.notifyStateChange(newState);\n    }\n  }\n\n  private hasStateChanged(\n    oldState: VolumioState,\n    newState: VolumioState,\n  ): boolean {\n    // Check key fields that indicate a meaningful state change\n    return (\n      oldState.status !== newState.status ||\n      oldState.position !== newState.position ||\n      oldState.title !== newState.title ||\n      oldState.volume !== newState.volume ||\n      oldState.mute !== newState.mute ||\n      oldState.random !== newState.random ||\n      oldState.repeat !== newState.repeat\n    );\n  }\n\n  private notifyStateChange(state: VolumioState): void {\n    this.logger.debug(\"Notifying state change callbacks\");\n    for (const callback of this.stateChangeCallbacks) {\n      try {\n        callback(state);\n      } catch (error) {\n        const errorMessage =\n          error instanceof Error ? error.message : String(error);\n        this.logger.error(`State change callback error: ${errorMessage}`);\n      }\n    }\n  }\n\n  private notifyConnectionChange(connected: boolean): void {\n    this.logger.debug(`Notifying connection change: ${connected}`);\n    for (const callback of this.connectionChangeCallbacks) {\n      try {\n        callback(connected);\n      } catch (error) {\n        const errorMessage =\n          error instanceof Error ? error.message : String(error);\n        this.logger.error(`Connection change callback error: ${errorMessage}`);\n      }\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": ["axios"]
}
